# Reconly OSS - Docker Compose Configuration
#
# Quick Start:
#   cp .env.example .env             # Create config from template (edit as needed)
#   docker compose up -d             # Start (empty database)
#   docker compose up -d --build     # Start with rebuild
#   docker compose logs -f api       # View API logs
#   docker compose down              # Stop all services
#   docker compose down -v           # Stop and delete data
#
# With sample data (recommended for first-time users):
#   LOAD_SAMPLE_DATA=true docker compose up -d
#
# With GPT Researcher (adds SearXNG search engine):
#   docker compose --profile research up -d
#
# Note: Sample data only loads once. A .seeded marker file in ./state/ prevents
# re-loading on subsequent starts. To fully reset with fresh sample data:
#   rm state/.seeded && docker compose down -v && docker compose up -d
#
# Environment variables (set in .env file or export):
#   RECONLY_VERSION       - Docker image version (default: latest, e.g., 1.5.0, edge)
#   LOAD_SAMPLE_DATA      - Load sample feeds/sources on first start (default: false)
#   API_PORT              - API port (default: 8000)
#   POSTGRES_PASSWORD     - PostgreSQL password (default: reconly)
#   ANTHROPIC_API_KEY     - Anthropic API key
#   OPENAI_API_KEY        - OpenAI API key
#   HUGGINGFACE_API_KEY   - HuggingFace API key
#   OLLAMA_HOST           - Ollama server URL (default: http://host.docker.internal:11434)
#   DEFAULT_PROVIDER      - Default LLM provider (anthropic/openai/huggingface/ollama)
#   RECONLY_EDITION       - Edition (oss/enterprise, default: oss)
#   RECONLY_AUTH_PASSWORD - Optional password protection
#   SCHEDULER_TIMEZONE    - Timezone for cron schedules (default: local)
#   SEARXNG_PORT          - SearXNG port (default: 8888, research profile only)

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: reconly-oss-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=reconly
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-reconly}
      - POSTGRES_DB=reconly
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../init-postgres.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reconly -d reconly"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/reconlyeu/reconly:${RECONLY_VERSION:-latest}
    # For development/building from source, use docker-compose.dev.yml instead:
    #   docker compose -f docker-compose.dev.yml up -d --build
    container_name: reconly-oss-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Database (PostgreSQL required)
      - DATABASE_URL=postgresql://reconly:${POSTGRES_PASSWORD:-reconly}@postgres:5432/reconly
      # Sample data (loads on first start if database is empty)
      - LOAD_SAMPLE_DATA=${LOAD_SAMPLE_DATA:-false}
      # LLM Providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_BASE_URL=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-}
      - DEFAULT_PROVIDER=${DEFAULT_PROVIDER:-ollama}
      # Edition & Auth
      - RECONLY_EDITION=${RECONLY_EDITION:-oss}
      - RECONLY_AUTH_PASSWORD=${RECONLY_AUTH_PASSWORD:-}
      # Scheduler
      - SCHEDULER_TIMEZONE=${SCHEDULER_TIMEZONE:-}
      # Research (SearXNG - only useful with --profile research)
      - SEARXNG_URL=${SEARXNG_URL:-}
    volumes:
      - reconly_data:/app/data
      - ./state:/app/state
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- Research profile (opt-in) ---
  # Start with: docker compose --profile research up -d

  valkey:
    image: valkey/valkey:8-alpine
    container_name: reconly-oss-valkey
    restart: unless-stopped
    profiles: ["research"]
    command: valkey-server --save 30 1 --loglevel warning
    volumes:
      - valkey_data:/data
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  searxng:
    image: searxng/searxng:latest
    container_name: reconly-oss-searxng
    restart: unless-stopped
    profiles: ["research"]
    depends_on:
      - valkey
    ports:
      - "${SEARXNG_PORT:-8888}:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:${SEARXNG_PORT:-8888}/
    volumes:
      - ../searxng:/etc/searxng:rw
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

volumes:
  postgres_data:
  reconly_data:
  valkey_data:
