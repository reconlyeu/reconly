# Reconly OSS - Docker Compose Configuration
#
# Quick Start:
#   docker compose up -d             # Start (empty database)
#   docker compose up -d --build     # Start with rebuild
#   docker compose logs -f api       # View API logs
#   docker compose down              # Stop all services
#   docker compose down -v           # Stop and delete data
#
# With sample data (recommended for first-time users):
#   LOAD_SAMPLE_DATA=true docker compose up -d
#
# Note: Sample data only loads once. A .seeded marker file in ./state/ prevents
# re-loading on subsequent starts. To fully reset with fresh sample data:
#   rm state/.seeded && docker compose down -v && docker compose up -d
#
# Environment variables (set in .env file or export):
#   RECONLY_VERSION       - Docker image version (default: latest, e.g., 1.5.0, edge)
#   LOAD_SAMPLE_DATA      - Load sample feeds/sources on first start (default: false)
#   API_PORT              - API port (default: 8000)
#   POSTGRES_PASSWORD     - PostgreSQL password (default: reconly)
#   ANTHROPIC_API_KEY     - Anthropic API key
#   OPENAI_API_KEY        - OpenAI API key
#   HUGGINGFACE_API_KEY   - HuggingFace API key
#   OLLAMA_HOST           - Ollama server URL (default: http://host.docker.internal:11434)
#   DEFAULT_PROVIDER      - Default LLM provider (anthropic/openai/huggingface/ollama)
#   RECONLY_EDITION       - Edition (oss/enterprise, default: oss)
#   RECONLY_AUTH_PASSWORD - Optional password protection
#   SCHEDULER_TIMEZONE    - Timezone for cron schedules (default: local)

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: reconly-oss-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=reconly
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-reconly}
      - POSTGRES_DB=reconly
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../init-postgres.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reconly -d reconly"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/reconlyeu/reconly:${RECONLY_VERSION:-latest}
    # For development/building from source, use docker-compose.dev.yml instead:
    #   docker compose -f docker-compose.dev.yml up -d --build
    container_name: reconly-oss-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Database (PostgreSQL required)
      - DATABASE_URL=postgresql://reconly:${POSTGRES_PASSWORD:-reconly}@postgres:5432/reconly
      # Sample data (loads on first start if database is empty)
      - LOAD_SAMPLE_DATA=${LOAD_SAMPLE_DATA:-false}
      # LLM Providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_BASE_URL=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-}
      - DEFAULT_PROVIDER=${DEFAULT_PROVIDER:-ollama}
      # Edition & Auth
      - RECONLY_EDITION=${RECONLY_EDITION:-oss}
      - RECONLY_AUTH_PASSWORD=${RECONLY_AUTH_PASSWORD:-}
      # Scheduler
      - SCHEDULER_TIMEZONE=${SCHEDULER_TIMEZONE:-}
    volumes:
      - reconly_data:/app/data
      - ./state:/app/state
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  postgres_data:
  reconly_data:
